name: AnyDesk-16GB-Gaming-Sync
on: workflow_dispatch

jobs:
  build:
    runs-on: windows-latest
    steps:
    - name: 0. Restore Previous Backup
      uses: dawidd6/action-download-artifact@v3
      continue-on-error: true # Prevents crash if this is your first time running it
      with:
        name: My-RDP-Backup
        path: C:\Restore
        workflow: Rdp3.yml # Updated to match your current filename

    - name: 1. Install AnyDesk
      run: |
        curl.exe -L -o anydesk.exe https://download.anydesk.com/AnyDesk.exe
        ./anydesk.exe --install C:\AnyDesk --start-with-win --silent
        Start-Sleep -Seconds 20
      shell: pwsh

    - name: 2. Set Password & Start Service
      run: |
        echo "GitHub@2026" | & "C:\AnyDesk\AnyDesk.exe" --set-password
        Start-Process "C:\AnyDesk\AnyDesk.exe" -ArgumentList "--service"
        Start-Sleep -Seconds 40
      shell: pwsh

    - name: 3. Apply Restore, Optimization & Deep Clean
      run: |
        # 1. Restore Registry Settings and Desktop Files
        if (Test-Path "C:\Restore\WindowsSettings.reg") {
            reg import "C:\Restore\WindowsSettings.reg"
        }
        if (Test-Path "C:\Restore\*") {
            Copy-Item -Path "C:\Restore\*" -Destination "C:\Users\runneradmin\Desktop" -Recurse -Force
        }

        # 2. DEEP CLEAN: Remove Unnecessary Apps
        Write-Host "Freeing up ~40GB of space... please wait." -ForegroundColor Cyan
        
        # Remove Visual Studio Enterprise (~31.78 GB)
        if (Test-Path "C:\Program Files (x86)\Microsoft Visual Studio\Installer\setup.exe") {
            Start-Process "C:\Program Files (x86)\Microsoft Visual Studio\Installer\setup.exe" -ArgumentList "uninstall --installPath `"C:\Program Files\Microsoft Visual Studio\2022\Enterprise`" --passive --norestart" -Wait
        }

        # Remove other large non-essential developer tools
        $appsToRemove = @(
            "PostgreSQL*", 
            "MySQL*", 
            "Strawberry Perl*", 
            "LLVM*", 
            "Unity Hub*", 
            "Microsoft Azure*",
            "Kindle",
            "Cmake",
            "Go Programming Language",
            "MongoDB*"
        )
        foreach ($app in $appsToRemove) {
            Get-Package -Name $app -ErrorAction SilentlyContinue | Uninstall-Package -Force -ErrorAction SilentlyContinue
        }

        # 3. Performance & Storage Tweaks
        compact.exe /compactos:always
        powercfg -h off
        
        Write-Host "Cleanup Complete! Extra space added for Chrome." -ForegroundColor Green
      shell: pwsh

    - name: 4. THE REVEAL
      run: |
        $ID = Select-String -Path "C:\ProgramData\AnyDesk\system.conf" -Pattern "ad.anynet.id=(.*)" | ForEach-Object { $_.Matches.Groups[1].Value }
        Write-Host "------------------------------------------------" -ForegroundColor Green
        Write-Host "ANYDESK ID: $ID" -ForegroundColor Yellow
        Write-Host "PASSWORD: GitHub@2026" -ForegroundColor White
        Write-Host "RAM: 16 GB ACTIVE" -ForegroundColor Green
        Write-Host "------------------------------------------------" -ForegroundColor Green
      shell: pwsh

    - name: 5. Keep Alive
      run: |
        # Runs for 6 hours
        $timeout = New-TimeSpan -Hours 6
        $stopwatch = [Diagnostics.Stopwatch]::StartNew()
        while ($stopwatch.Elapsed -lt $timeout) { Start-Sleep -Seconds 60 }
      shell: pwsh

    - name: 6. Auto-Backup Progress
      if: always()
      run: |
        New-Item -Path "C:\Backup" -ItemType Directory -Force
        # Saves your Wallpaper and UI settings
        reg export "HKCU\Software" "C:\Backup\WindowsSettings.reg" /y
        # Saves everything on your Desktop
        Copy-Item -Path "C:\Users\runneradmin\Desktop\*" -Destination "C:\Backup" -Recurse -ErrorAction SilentlyContinue
      shell: pwsh

    - name: 7. Upload Backup to GitHub
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: My-RDP-Backup
        path: C:\Backup
        retention-days: 7
