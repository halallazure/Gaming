name: AnyDesk-16GB-Gaming-Sync
on: workflow_dispatch

jobs:
  build:
    runs-on: windows-latest
    steps:
    - name: 0. SMART RESTORE (Settings & Files)
      uses: dawidd6/action-download-artifact@v3
      continue-on-error: true 
      with:
        name: My-RDP-Backup
        path: C:\Restore
        workflow: Rdp3.yml # Fixed name to match your file

    - name: 1. Instant Setup
      run: |
        curl.exe -L -o anydesk.exe https://download.anydesk.com/AnyDesk.exe
        ./anydesk.exe --install C:\AnyDesk --start-with-win --silent
        echo "GitHub@2026" | & "C:\AnyDesk\AnyDesk.exe" --set-password
        Start-Process "C:\AnyDesk\AnyDesk.exe" -ArgumentList "--service"
        Start-Sleep -Seconds 10
      shell: pwsh

    - name: 2. MAJOR PERSISTENCE ENHANCEMENTS
      run: |
        # --- ENHANCEMENT 1: WALLPAPER & UI RESTORE ---
        if (Test-Path "C:\Restore\WindowsSettings.reg") {
            Write-Host "Restoring your wallpaper and settings..." -ForegroundColor Cyan
            reg import "C:\Restore\WindowsSettings.reg"
            # Refresh the desktop to show the wallpaper immediately
            RUNDLL32.EXE user32.dll,UpdatePerUserSystemParameters
        }

        # --- ENHANCEMENT 2: DESKTOP FILE RESTORE ---
        if (Test-Path "C:\Restore\*") {
            Copy-Item -Path "C:\Restore\*" -Destination "$HOME\Desktop" -Recurse -Force
        }

        # --- ENHANCEMENT 3: PERFORMANCE ---
        powercfg -h off
        Write-Host "Success: All changes from your last session are back!" -ForegroundColor Green
      shell: pwsh

    - name: 3. THE REVEAL
      run: |
        $ID = Select-String -Path "C:\ProgramData\AnyDesk\system.conf" -Pattern "ad.anynet.id=(.*)" | ForEach-Object { $_.Matches.Groups[1].Value }
        Write-Host "ANYDESK ID: $ID" -ForegroundColor Yellow
        Write-Host "PASSWORD: GitHub@2026" -ForegroundColor White
      shell: pwsh

    - name: 4. Keep Alive
      run: |
        $timeout = New-TimeSpan -Hours 6
        $stopwatch = [Diagnostics.Stopwatch]::StartNew()
        while ($stopwatch.Elapsed -lt $timeout) { Start-Sleep -Seconds 60 }
      shell: pwsh

    - name: 5. SMART BACKUP ENGINE (Major Enhancement)
      if: always()
      run: |
        New-Item -Path "C:\Backup" -ItemType Directory -Force
        
        # --- ENHANCEMENT 4: SETTINGS CAPTURE ---
        # This saves your wallpaper path and Windows personalization
        reg export "HKCU\Control Panel\Desktop" "C:\Backup\WindowsSettings.reg" /y
        reg export "HKCU\Software\Microsoft\Windows\CurrentVersion\Explorer\Wallpapers" "C:\Backup\WallpaperPath.reg" /y
        
        # --- ENHANCEMENT 5: FILE CAPTURE ---
        # Saves everything you left on the Desktop
        Copy-Item -Path "$HOME\Desktop\*" -Destination "C:\Backup" -Recurse -ErrorAction SilentlyContinue
      shell: pwsh

    - name: 6. Secure Upload
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: My-RDP-Backup
        path: C:\Backup
        retention-days: 7
