name: AnyDesk-16GB-Final-Anyhow
on: workflow_dispatch

jobs:
  build:
    runs-on: windows-latest
    steps:
    - name: 1. Install AnyDesk to Fixed Path
      run: |
        curl.exe -L -o anydesk.exe https://download.anydesk.com/AnyDesk.exe
        # Installing to the path established in your previous logs
        ./anydesk.exe --install C:\AnyDesk --start-with-win --silent
        Start-Sleep -Seconds 15
      shell: pwsh

    - name: 2. Force Unattended Access (Fixed Argument Syntax)
      run: |
        $Password = "GitHub@2026"
        # Force kill stuck processes to prevent 'Service Busy' errors
        taskkill /F /IM AnyDesk.exe /T 2>$null
        
        # Inject the password using the working echo method
        echo $Password | & "C:\AnyDesk\AnyDesk.exe" --set-password
        
        # CORRECTED START COMMAND: Using -ArgumentList properly to avoid positional errors
        Write-Host "Forcing service start with correct parameters..." -ForegroundColor Cyan
        Start-Process "C:\AnyDesk\AnyDesk.exe" -ArgumentList "--service"
        
        # Wait for the ID to register on the network
        Start-Sleep -Seconds 30
      shell: pwsh

    - name: 3. THE REVEAL
      run: |
        # Directly pull ID from system config for 100% accuracy
        $ID = Select-String -Path "C:\ProgramData\AnyDesk\system.conf" -Pattern "ad.anynet.id=(.*)" | ForEach-Object { $_.Matches.Groups[1].Value }
        $PublicIP = curl.exe -s https://api.ipify.org
        
        Write-Host "------------------------------------------------" -ForegroundColor Green
        if ($ID) { Write-Host "ANYDESK ID: $ID" -ForegroundColor Yellow }
        else { Write-Host "ID NOT READY - REFRESH LOGS IN 10 SECONDS" -ForegroundColor Red }
        Write-Host "PASSWORD: GitHub@2026" -ForegroundColor White
        Write-Host "LG TV IP: $PublicIP" -ForegroundColor Cyan
        Write-Host "------------------------------------------------" -ForegroundColor Green
      shell: pwsh

    - name: 4. Keep Alive
      run: while($true){ Start-Sleep -Seconds 60 }
