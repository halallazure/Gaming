name: AnyDesk-Force-Fix-16GB
on: workflow_dispatch

jobs:
  build:
    runs-on: windows-latest
    steps:
    - name: 1. Install AnyDesk to Fixed Path
      run: |
        curl.exe -L -o anydesk.exe https://download.anydesk.com/AnyDesk.exe
        # Install to C:\AnyDesk
        ./anydesk.exe --install C:\AnyDesk --start-with-win --silent
        Start-Sleep -Seconds 15
      shell: pwsh

    - name: 2. Force Unattended Access (Registry Method)
      run: |
        $Password = "GitHub@2026"
        # Force kill any stuck processes
        taskkill /F /IM AnyDesk.exe /T 2>$null
        
        # Inject the password directly into the AnyDesk configuration
        # This prevents the "Service starting or stopping" error
        echo $Password | & "C:\AnyDesk\AnyDesk.exe" --set-password
        
        # Manually trigger the service start without using 'net start'
        Write-Host "Forcing service start..." -ForegroundColor Cyan
        Start-Process "C:\AnyDesk\AnyDesk.exe" --argumentlist "--service"
        
        # Wait for the network to register the ID
        Start-Sleep -Seconds 30
      shell: pwsh

    - name: 3. THE REVEAL
      run: |
        # Pull the ID from the system config file directly
        $ID = Select-String -Path "C:\ProgramData\AnyDesk\system.conf" -Pattern "ad.anynet.id=(.*)" | ForEach-Object { $_.Matches.Groups[1].Value }
        $PublicIP = curl.exe -s https://api.ipify.org
        
        Write-Host "------------------------------------------------" -ForegroundColor Green
        Write-Host "ANYDESK ID: $ID" -ForegroundColor Yellow
        Write-Host "PASSWORD: GitHub@2026" -ForegroundColor White
        Write-Host "LG TV IP: $PublicIP" -ForegroundColor Cyan
        Write-Host "------------------------------------------------" -ForegroundColor Green
        
        # If ID is still blank, force a CLI check
        if (!$ID) { & "C:\AnyDesk\AnyDesk.exe" --get-id }
      shell: pwsh

    - name: 4. Keep Alive
      run: while($true){ Start-Sleep -Seconds 60 }
