name: AnyDesk-40GB-Dual-Sync-Fixed
on: workflow_dispatch

jobs:
  build:
    runs-on: windows-latest
    steps:
    - name: 0. Fast Restore (Pulling from 40GB Cloud)
      continue-on-error: true
      run: |
        # Fixed Download Link for MEGA CMD
        curl.exe -L -o megasetup.exe https://mega.nz/megacmd/MEGAsyncSetup.exe
        
        # Install with specific parameters for GitHub Runners
        Start-Process ./megasetup.exe -ArgumentList "/S" -Wait
        
        # Set Path so the runner can see the 'mega-' commands
        $env:PATH += ";C:\AppData\Local\MEGAcmd;C:\Program Files\MEGAcmd"
        New-Item -Path "C:\Restore" -ItemType Directory -Force
        
        # Login and Pull from Account 1
        mega-login halallazure@gmail.com 123456seven
        mega-get /RDP_Backups/Part1/* C:\Restore\
        mega-logout
        
        # Login and Pull from Account 2
        mega-login halallyeager@gmail.com 123456seven
        mega-get /RDP_Backups/Part2/* C:\Restore\
        mega-logout
      shell: pwsh

    - name: 1. Setup AnyDesk
      run: |
        curl.exe -L -o anydesk.exe https://download.anydesk.com/AnyDesk.exe
        ./anydesk.exe --install C:\AnyDesk --start-with-win --silent
        Start-Sleep -Seconds 5
        echo "GitHub@2026" | & "C:\AnyDesk\AnyDesk.exe" --set-password
        Start-Process "C:\AnyDesk\AnyDesk.exe" -ArgumentList "--service"
      shell: pwsh

    - name: 2. Inject Wallpaper, Settings & Folders
      run: |
        # Apply Registry Settings (Wallpaper/Themes)
        if (Test-Path "C:\Restore\WindowsSettings.reg") { 
            reg import "C:\Restore\WindowsSettings.reg"
            RUNDLL32.EXE user32.dll,UpdatePerUserSystemParameters
        }
        # Restore all Desktop folders and files
        if (Test-Path "C:\Restore\*") { 
            Copy-Item -Path "C:\Restore\*" -Destination "$HOME\Desktop" -Recurse -Force 
        }
        powercfg -h off
        Write-Host "Sync Complete: Desktop Restored!" -ForegroundColor Green
      shell: pwsh

    - name: 3. THE REVEAL
      run: |
        $ID = Select-String -Path "C:\ProgramData\AnyDesk\system.conf" -Pattern "ad.anynet.id=(.*)" | ForEach-Object { $_.Matches.Groups[1].Value }
        Write-Host "------------------------------------------------" -ForegroundColor Green
        Write-Host "ANYDESK ID: $ID" -ForegroundColor Yellow
        Write-Host "PASSWORD: GitHub@2026" -ForegroundColor White
        Write-Host "------------------------------------------------" -ForegroundColor Green
      shell: pwsh

    - name: 4. Keep Alive (6-Hour Active Session)
      run: |
        $timeout = New-TimeSpan -Hours 6
        $stopwatch = [Diagnostics.Stopwatch]::StartNew()
        while ($stopwatch.Elapsed -lt $timeout) { Start-Sleep -Seconds 60 }
      shell: pwsh

    - name: 5. TOTAL SAVE (Split Sync to 2 Accounts)
      if: always()
      run: |
        $env:PATH += ";C:\AppData\Local\MEGAcmd;C:\Program Files\MEGAcmd"
        # Export settings before backup
        reg export "HKCU\Control Panel\Desktop" "$HOME\Desktop\WindowsSettings.reg" /y
        
        # Get all desktop items and split them
        $items = Get-ChildItem -Path "$HOME\Desktop\*"
        $half = [Math]::Ceiling($items.Count / 2)
        $group1 = $items | Select-Object -First $half
        $group2 = $items | Select-Object -Last ($items.Count - $half)

        # Create temporary upload buffers
        New-Item -Path "C:\Backup1" -ItemType Directory -Force
        New-Item -Path "C:\Backup2" -ItemType Directory -Force
        if ($group1) { $group1 | Copy-Item -Destination "C:\Backup1" -Recurse }
        if ($group2) { $group2 | Copy-Item -Destination "C:\Backup2" -Recurse }

        # Upload Group 1 to Account 1
        mega-login halallazure@gmail.com 123456seven
        mega-rm -r /RDP_Backups/Part1
        mega-mkdir /RDP_Backups/Part1
        mega-put "C:\Backup1\*" /RDP_Backups/Part1/
        mega-logout

        # Upload Group 2 to Account 2
        mega-login halallyeager@gmail.com 123456seven
        mega-rm -r /RDP_Backups/Part2
        mega-mkdir /RDP_Backups/Part2
        mega-put "C:\Backup2\*" /RDP_Backups/Part2/
        Write-Host "All changes saved across both accounts!" -ForegroundColor Green
      shell: pwsh
