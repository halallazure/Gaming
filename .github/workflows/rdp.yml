name: AnyDesk-Total-Sync-Pro
on: workflow_dispatch

jobs:
  build:
    runs-on: windows-latest
    steps:
    - name: 0. Fast Restore (Startup)
      continue-on-error: true
      run: |
        choco install megacmd -y --no-progress
        $mega = "C:\Program Files\MEGAcmd\mega-exec.exe"
        if (Test-Path $mega) {
            & $mega login halallazure@gmail.com 123456seven
            New-Item -Path "C:\Restore" -ItemType Directory -Force
            & $mega get /RDP_Backups/Part1/* C:\Restore\
            & $mega logout
            # Restore files and settings
            if (Test-Path "C:\Restore\*") {
                Copy-Item -Path "C:\Restore\*" -Destination "$HOME\Desktop" -Recurse -Force
            }
        }
      shell: pwsh

    - name: 1. Setup AnyDesk & Manual Save Button
      run: |
        # 1. AnyDesk Install
        curl.exe -L -o anydesk.exe https://download.anydesk.com/AnyDesk.exe
        ./anydesk.exe --install C:\AnyDesk --start-with-win --silent
        Start-Sleep -Seconds 10
        echo "GitHub@2026" | & "C:\AnyDesk\AnyDesk.exe" --set-password
        Start-Process "C:\AnyDesk\AnyDesk.exe" -ArgumentList "--service"

        # 2. CREATE THE MANUAL SAVE SCRIPT (On Desktop)
        $SaveScript = @"
        `$mega = "C:\Program Files\MEGAcmd\mega-exec.exe"
        Write-Host "Capturing Settings..." -ForegroundColor Cyan
        reg export "HKCU\Control Panel\Desktop" "`$HOME\Desktop\WindowsSettings.reg" /y
        & "`$mega" login halallazure@gmail.com 123456seven
        & "`$mega" rm -r /RDP_Backups/Part1
        & "`$mega" mkdir -p /RDP_Backups/Part1
        & "`$mega" put "`$HOME\Desktop\*" /RDP_Backups/Part1/
        Write-Host "Uploading... Please wait..." -ForegroundColor Yellow
        while ((& "`$mega" transfers) -notlike "*No active transfers*") { Start-Sleep -Seconds 5 }
        & "`$mega" logout
        msg * "SUCCESS: Everything is saved to MEGA!"
"@
        $SaveScript | Out-File -FilePath "$HOME\Desktop\SAVE_NOW.ps1" -Encoding utf8

        # 3. CREATE DESKTOP SHORTCUT
        $WshShell = New-Object -ComObject WScript.Shell
        $Shortcut = $WshShell.CreateShortcut("$HOME\Desktop\CLICK_TO_SAVE.lnk")
        $Shortcut.TargetPath = "powershell.exe"
        $Shortcut.Arguments = "-ExecutionPolicy Bypass -File `"$HOME\Desktop\SAVE_NOW.ps1`""
        $Shortcut.IconLocation = "shell32.dll,258" 
        $Shortcut.Save()
      shell: pwsh

    - name: 2. Reveal ID & Apply Theme
      run: |
        # Force Wallpaper Update
        if (Test-Path "$HOME\Desktop\WindowsSettings.reg") { 
            reg import "$HOME\Desktop\WindowsSettings.reg"
            RUNDLL32.EXE user32.dll,UpdatePerUserSystemParameters
        }
        # Reveal AnyDesk ID
        $ID = Select-String -Path "C:\ProgramData\AnyDesk\system.conf" -Pattern "ad.anynet.id=(.*)" | ForEach-Object { $_.Matches.Groups[1].Value }
        Write-Host "------------------------------------------------" -ForegroundColor Green
        Write-Host "      ID: $ID | PASSWORD: GitHub@2026"
        Write-Host "------------------------------------------------" -ForegroundColor Green
      shell: pwsh

    - name: 3. Session Timer (Auto-Save Trigger)
      run: |
        # 5h 45m timer gives 15m for the Auto-Save to finish
        $timeout = New-TimeSpan -Hours 5 -Minutes 45
        $stopwatch = [Diagnostics.Stopwatch]::StartNew()
        while ($stopwatch.Elapsed -lt $timeout) { Start-Sleep -Seconds 60 }

    - name: 4. AUTO-SAVE SAFETY NET
      if: always()
      run: |
        $mega = "C:\Program Files\MEGAcmd\mega-exec.exe"
        if (Test-Path $mega) {
            reg export "HKCU\Control Panel\Desktop" "$HOME\Desktop\WindowsSettings.reg" /y
            & $mega login halallazure@gmail.com 123456seven
            & $mega rm -r /RDP_Backups/Part1
            & $mega put "$HOME\Desktop\*" /RDP_Backups/Part1/
            # Force the runner to wait for the upload to hit 100%
            $wait = 0
            while ((& $mega transfers) -notlike "*No active transfers*" -and $wait -lt 20) { 
                Start-Sleep -Seconds 10
                $wait++
            }
        }
      shell: pwsh
