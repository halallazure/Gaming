name: Apex-Ultra-1080p-60FPS
on: workflow_dispatch

jobs:
  build:
    # Upgraded to 2022 for superior virtualization and UI fluidity
    runs-on: windows-2022 
    timeout-minutes: 360

    steps:
    - name: 1. Core Performance & Runtime Injection
      shell: pwsh
      run: |
        # Create dedicated high-speed directories
        New-Item -Path "C:\GamingVM\Backup" -ItemType Directory -Force
        
        # Install Visual C++ (Critical for smooth rendering & wallpapers)
        Write-Host "Installing Visual C++ Runtimes..." -ForegroundColor Cyan
        curl.exe -L -o vc_redist.x64.exe https://aka.ms/vs/17/release/vc_redist.x64.exe
        Start-Process ./vc_redist.x64.exe -ArgumentList "/install /quiet /norestart" -Wait
        
        # Deploy AnyDesk
        Write-Host "Deploying AnyDesk..." -ForegroundColor Cyan
        curl.exe -L -o anydesk.exe https://download.anydesk.com/AnyDesk.exe
        Start-Process ./anydesk.exe -ArgumentList "--install C:\AnyDesk --start-with-win --silent" -Wait

    - name: 2. Registry & GPU Fluidity Tweaks
      shell: pwsh
      run: |
        Write-Host "Applying GPU and Performance Tweaks..." -ForegroundColor Cyan
        
        # Disable Desktop Composition Redirection lag (Fixes UI stutter)
        & reg.exe add "HKCU\Software\Microsoft\Windows\CurrentVersion\Explorer\VisualEffects" /v VisualFXSetting /t REG_DWORD /d 2 /f
        
        # Inject High-Performance settings into AnyDesk configuration
        $adConfig = "C:\ProgramData\AnyDesk\system.conf"
        Start-Sleep -Seconds 10
        if (Test-Path $adConfig) {
          Add-Content $adConfig "`nad.display.directx=1"
          Add-Content $adConfig "`nad.display.fps=60"
          Add-Content $adConfig "`nad.display.quality=1"
          Write-Host "AnyDesk set to 60FPS DirectX Mode." -ForegroundColor Green
        }
        
        # Set High Performance Power Plan (Prevents CPU throttling)
        & powercfg.exe /s 8c5e7fda-e8bf-4a96-9a85-a6e23a8c635c
        
        # Compact OS to free up IOPS for live wallpapers
        & compact.exe /compactos:always
        
        # Turn off Hibernation to save disk space
        & powercfg.exe -h off

    - name: 3. Credential Injection & ID Reveal
      shell: pwsh
      run: |
        # Set access password
        echo "GitHub@2026" | & "C:\AnyDesk\AnyDesk.exe" --set-password
        
        # Dynamic ID extraction with robust retry logic
        $idFile = "C:\ProgramData\AnyDesk\system.conf"
        $ID = ""
        $attempts = 0
        while (!$ID -and $attempts -lt 15) {
          if (Test-Path $idFile) { 
            $ID = Select-String -Path $idFile -Pattern "ad.anynet.id=(.*)" | % { $_.Matches.Groups[1].Value } 
          }
          if (!$ID) { Start-Sleep -Seconds 5; $attempts++ }
        }
        
        Write-Host "================================================" -ForegroundColor Cyan
        Write-Host " ACCESS GRANTED - PERFORMANCE MODE ACTIVE " -ForegroundColor Green -BackgroundColor Black
        Write-Host " ANYDESK ID: $ID" -ForegroundColor Yellow
        Write-Host " PASSWORD:    GitHub@2026" -ForegroundColor White
        Write-Host " RESOLUTION:  1080p @ 60 FPS (Minimum)" -ForegroundColor Green
        Write-Host "================================================" -ForegroundColor Cyan

    - name: 4. The Infinite Ultra-Loop
      shell: pwsh
      run: |
        Write-Host "VM is now live. Keep this browser tab open." -ForegroundColor Cyan
        $timeout = New-TimeSpan -Hours 6
        $stopwatch = [Diagnostics.Stopwatch]::StartNew()
        while ($stopwatch.Elapsed -lt $timeout) {
          $timeLeft = $timeout - $stopwatch.Elapsed
          Write-Host "Session active. Time remaining: $($timeLeft.ToString('hh\:mm\:ss'))"
          Start-Sleep -Seconds 60
        }

    - name: 5. Final Safety Sync
      if: always()
      shell: pwsh
      run: |
        Write-Host "Backing up session settings..." -ForegroundColor Cyan
        # Backup system registry for next session
        & reg.exe export "HKEY_CURRENT_USER\Control Panel\Desktop" "C:\GamingVM\Backup\System.reg" /y
