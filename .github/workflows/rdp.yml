name: AnyDesk-40GB-Deep-Sync
on: workflow_dispatch

jobs:
  build:
    runs-on: windows-latest
    steps:
    - name: 0. Fast Restore (Themes & Files)
      continue-on-error: true
      run: |
        choco install megacmd -y --no-progress
        $mega = "C:\Program Files\MEGAcmd\mega-exec.exe"
        New-Item -Path "C:\Restore" -ItemType Directory -Force
        
        if (Test-Path $mega) {
            # Pull from both accounts
            & $mega login halallazure@gmail.com 123456seven
            & $mega get /RDP_Backups/Part1/* C:\Restore\
            & $mega logout
            
            & $mega login halallyeager@gmail.com 123456seven
            & $mega get /RDP_Backups/Part2/* C:\Restore\
            & $mega logout
        }
      shell: pwsh

    - name: 1. Setup AnyDesk
      run: |
        curl.exe -L -o anydesk.exe https://download.anydesk.com/AnyDesk.exe
        ./anydesk.exe --install C:\AnyDesk --start-with-win --silent
        Start-Sleep -Seconds 5
        echo "GitHub@2026" | & "C:\AnyDesk\AnyDesk.exe" --set-password
        Start-Process "C:\AnyDesk\AnyDesk.exe" -ArgumentList "--service"
      shell: pwsh

    - name: 2. Apply Theme & Move Files
      run: |
        # 1. Restore the Theme/Wallpaper files
        $themePath = "$HOME\AppData\Local\Microsoft\Windows\Themes"
        if (Test-Path "C:\Restore\Themes") {
            Copy-Item -Path "C:\Restore\Themes\*" -Destination $themePath -Recurse -Force
        }
        # 2. Apply Registry and Refresh UI
        if (Test-Path "C:\Restore\WindowsSettings.reg") { 
            reg import "C:\Restore\WindowsSettings.reg"
            RUNDLL32.EXE user32.dll,UpdatePerUserSystemParameters
        }
        # 3. Restore Desktop Folders
        if (Test-Path "C:\Restore\*") { 
            Copy-Item -Path "C:\Restore\*" -Destination "$HOME\Desktop" -Exclude "Themes","WindowsSettings.reg" -Recurse -Force 
        }
        powercfg -h off
      shell: pwsh

    - name: 4. Keep Alive
      run: |
        $timeout = New-TimeSpan -Hours 6
        $stopwatch = [Diagnostics.Stopwatch]::StartNew()
        while ($stopwatch.Elapsed -lt $timeout) { Start-Sleep -Seconds 60 }

    - name: 5. FORCED DEEP SAVE
      if: always()
      run: |
        $mega = "C:\Program Files\MEGAcmd\mega-exec.exe"
        # Export Settings and Theme Folder
        reg export "HKCU\Control Panel\Desktop" "$HOME\Desktop\WindowsSettings.reg" /y
        New-Item -Path "$HOME\Desktop\Themes" -ItemType Directory -Force
        Copy-Item -Path "$HOME\AppData\Local\Microsoft\Windows\Themes\*" -Destination "$HOME\Desktop\Themes" -Recurse -Force

        $items = Get-ChildItem -Path "$HOME\Desktop\*"
        $half = [Math]::Ceiling($items.Count / 2)
        
        New-Item -Path "C:\Backup1" -ItemType Directory -Force
        New-Item -Path "C:\Backup2" -ItemType Directory -Force
        $items | Select-Object -First $half | Copy-Item -Destination "C:\Backup1" -Recurse
        $items | Select-Object -Last ($items.Count - $half) | Copy-Item -Destination "C:\Backup2" -Recurse

        # Upload & Force Sync (Ensures files actually reach MEGA)
        & $mega login halallazure@gmail.com 123456seven
        & $mega rm -r /RDP_Backups/Part1
        & $mega put "C:\Backup1" /RDP_Backups/Part1
        & $mega sync # This forces the upload to finish before logout
        & $mega logout

        & $mega login halallyeager@gmail.com 123456seven
        & $mega rm -r /RDP_Backups/Part2
        & $mega put "C:\Backup2" /RDP_Backups/Part2
        & $mega sync
        & $mega logout
      shell: pwsh
