name: AnyDesk-MEGA-Ironclad-Sync
on: workflow_dispatch

jobs:
  build:
    runs-on: windows-latest
    steps:
    - name: 0. Ultra-Restore (Files & Registry)
      continue-on-error: true
      run: |
        choco install megacmd -y --no-progress
        $mega = "C:\Program Files\MEGAcmd\mega-exec.exe"
        
        if (Test-Path $mega) {
            & $mega login halallazure@gmail.com 123456seven
            # Create a clean folder for the download
            New-Item -Path "C:\DataDump" -ItemType Directory -Force
            & $mega get /RDP_Backups/Part1/* C:\DataDump\
            & $mega logout
            
            # Move files to Desktop immediately
            if (Test-Path "C:\DataDump\*") {
                Copy-Item -Path "C:\DataDump\*" -Destination "$HOME\Desktop" -Recurse -Force
            }
        }
      shell: pwsh

    - name: 1. Start AnyDesk & Reveal ID
      run: |
        curl.exe -L -o anydesk.exe https://download.anydesk.com/AnyDesk.exe
        ./anydesk.exe --install C:\AnyDesk --start-with-win --silent
        Start-Sleep -Seconds 15
        echo "GitHub@2026" | & "C:\AnyDesk\AnyDesk.exe" --set-password
        Start-Process "C:\AnyDesk\AnyDesk.exe" -ArgumentList "--service"
        
        $ID = Select-String -Path "C:\ProgramData\AnyDesk\system.conf" -Pattern "ad.anynet.id=(.*)" | ForEach-Object { $_.Matches.Groups[1].Value }
        Write-Host "------------------------------------------------" -ForegroundColor Green
        Write-Host "      ANYDESK ID: $ID" -ForegroundColor Yellow
        Write-Host "      PASSWORD:   GitHub@2026" -ForegroundColor White
        Write-Host "------------------------------------------------" -ForegroundColor Green
      shell: pwsh

    - name: 2. Force Apply Background & Registry
      run: |
        # Check if the registry file exists on the desktop
        $regFile = "$HOME\Desktop\WindowsSettings.reg"
        if (Test-Path $regFile) { 
            reg import $regFile
            # This command forces the wallpaper to update from the registry
            RUNDLL32.EXE user32.dll,UpdatePerUserSystemParameters
        }
        powercfg -h off
      shell: pwsh

    - name: 3. Session Timer (5h 40m)
      run: |
        # Ending early to guarantee upload time
        $timeout = New-TimeSpan -Hours 5 -Minutes 40
        $stopwatch = [Diagnostics.Stopwatch]::StartNew()
        while ($stopwatch.Elapsed -lt $timeout) { Start-Sleep -Seconds 60 }

    - name: 4. THE FORCED SAVE (Blocking Upload)
      if: always()
      run: |
        $mega = "C:\Program Files\MEGAcmd\mega-exec.exe"
        
        # 1. Capture the current wallpaper/theme settings
        reg export "HKCU\Control Panel\Desktop" "$HOME\Desktop\WindowsSettings.reg" /y
        
        # 2. Login and BLOCK until upload is done
        if (Test-Path $mega) {
            & $mega login halallazure@gmail.com 123456seven
            
            # Delete old backup to prevent storage full error
            & $mega rm -r /RDP_Backups/Part1
            & $mega mkdir -p /RDP_Backups/Part1
            
            # Upload EVERYTHING from Desktop
            & $mega put "$HOME\Desktop\*" /RDP_Backups/Part1/
            
            # IMPORTANT: This forces the script to wait for the transfer to hit 100%
            Write-Host "Forcing Sync... Do not close." -ForegroundColor Cyan
            $waitCount = 0
            while ($waitCount -lt 20) {
                $status = & $mega transfers
                if ($status -like "*No active transfers*") { break }
                Start-Sleep -Seconds 10
                $waitCount++
            }
            
            & $mega logout
            Write-Host "SAVE COMPLETE" -ForegroundColor Green
        }
      shell: pwsh
