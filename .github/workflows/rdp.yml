name: AnyDesk-MEGA-Path-Corrected
on: workflow_dispatch

jobs:
  build:
    runs-on: windows-latest
    steps:
    - name: 0. Fast Restore (Path Fix)
      continue-on-error: true
      run: |
        # 1. Download MEGA-CMD Installer
        curl.exe -L -o megacmd_setup.exe https://mega.nz/megacmd/MEGAsyncSetup.exe
        
        # 2. Verify file exists and then Install Silently
        if (Test-Path "megacmd_setup.exe") {
            Start-Process ".\megacmd_setup.exe" -ArgumentList "/S" -Wait
        }
        
        Start-Sleep -Seconds 20
        
        # 3. Locate the Executable
        $mega = "C:\Users\runneradmin\AppData\Local\MEGAcmd\mega-exec.exe"
        if (!(Test-Path $mega)) { $mega = "C:\Program Files (x86)\MEGAcmd\mega-exec.exe" }
        
        # 4. Restore files from halallazure@gmail.com
        if (Test-Path $mega) {
            New-Item -Path "C:\Restore" -ItemType Directory -Force
            & $mega login halallazure@gmail.com 123456seven
            & $mega get /RDP_Backups/Latest/* C:\Restore\
            & $mega logout
        }
      shell: pwsh

    - name: 1. Setup AnyDesk
      run: |
        curl.exe -L -o anydesk.exe https://download.anydesk.com/AnyDesk.exe
        ./anydesk.exe --install C:\AnyDesk --start-with-win --silent
        Start-Sleep -Seconds 5
        echo "GitHub@2026" | & "C:\AnyDesk\AnyDesk.exe" --set-password
        Start-Process "C:\AnyDesk\AnyDesk.exe" -ArgumentList "--service"
      shell: pwsh

    - name: 2. Inject Wallpaper & Folders
      run: |
        # Apply Wallpaper/Settings
        if (Test-Path "C:\Restore\WindowsSettings.reg") { 
            reg import "C:\Restore\WindowsSettings.reg"
            RUNDLL32.EXE user32.dll,UpdatePerUserSystemParameters
        }
        # Restore folders to Desktop
        if (Test-Path "C:\Restore\*") { 
            Copy-Item -Path "C:\Restore\*" -Destination "$HOME\Desktop" -Recurse -Force 
        }
        powercfg -h off
      shell: pwsh

    - name: 3. THE REVEAL
      run: |
        $ID = Select-String -Path "C:\ProgramData\AnyDesk\system.conf" -Pattern "ad.anynet.id=(.*)" | ForEach-Object { $_.Matches.Groups[1].Value }
        Write-Host "------------------------------------------------" -ForegroundColor Green
        Write-Host "ANYDESK ID: $ID" -ForegroundColor Yellow
        Write-Host "PASSWORD: GitHub@2026" -ForegroundColor White
        Write-Host "------------------------------------------------" -ForegroundColor Green
      shell: pwsh

    - name: 4. Keep Alive
      run: |
        $timeout = New-TimeSpan -Hours 6
        $stopwatch = [Diagnostics.Stopwatch]::StartNew()
        while ($stopwatch.Elapsed -lt $timeout) { Start-Sleep -Seconds 60 }
      shell: pwsh

    - name: 5. TOTAL SAVE (Always Saves)
      if: always()
      run: |
        $mega = "C:\Users\runneradmin\AppData\Local\MEGAcmd\mega-exec.exe"
        if (!(Test-Path $mega)) { $mega = "C:\Program Files (x86)\MEGAcmd\mega-exec.exe" }
        
        if (Test-Path $mega) {
            reg export "HKCU\Control Panel\Desktop" "$HOME\Desktop\WindowsSettings.reg" /y
            & $mega login halallazure@gmail.com 123456seven
            & $mega rm -r /RDP_Backups/Latest
            & $mega mkdir -p /RDP_Backups/Latest
            & $mega put "$HOME\Desktop\*" /RDP_Backups/Latest/
        }
      shell: pwsh
