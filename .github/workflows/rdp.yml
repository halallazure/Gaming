name: Apex-Ultra-1080p-60FPS
on: workflow_dispatch

jobs:
  build:
    # [span_0](start_span)Using Windows 2022 for better driver support and virtualization stability[span_0](end_span)
    runs-on: windows-2022 
    timeout-minutes: 360

    steps:
    - name: 1. Core Performance & Runtime Injection
      shell: pwsh
      run: |
        # [span_1](start_span)Create dedicated high-speed directories[span_1](end_span)
        New-Item -Path "C:\GamingVM\Backup" -ItemType Directory -Force
        
        # [span_2](start_span)Install Visual C++ (Critical for smooth UI rendering and wallpapers)[span_2](end_span)
        $vcUrl = "https://aka.ms/vs/17/release/vc_redist.x64.exe"
        curl.exe -L -o vc_redist.x64.exe $vcUrl
        Start-Process ./vc_redist.x64.exe -ArgumentList "/install /quiet /norestart" -Wait
        
        # [span_3](start_span)Deploy AnyDesk with localized installation[span_3](end_span)
        curl.exe -L -o anydesk.exe https://download.anydesk.com/AnyDesk.exe
        Start-Process ./anydesk.exe -ArgumentList "--install C:\AnyDesk --start-with-win --silent" -Wait

        - name: 2. Registry & GPU Fluidity Tweaks
      shell: pwsh
      run: |
        # 1. Disable Desktop Composition Redirection lag
        reg.exe add "HKCU\Software\Microsoft\Windows\CurrentVersion\Explorer\VisualEffects" /v VisualFXSetting /t REG_DWORD /d 2 /f
        
        # 2. Force AnyDesk to 60FPS and DirectX mode
        $adConfig = "C:\ProgramData\AnyDesk\system.conf"
        Start-Sleep -Seconds 5
        if (Test-Path $adConfig) {
          Add-Content $adConfig "`nad.display.directx=1"
          Add-Content $adConfig "`nad.display.fps=60"
          Add-Content $adConfig "`nad.display.quality=1"
        }
        
        # 3. Set High Performance Power Plan
        powercfg.exe /s 8c5e7fda-e8bf-4a96-9a85-a6e23a8c635c
        
        # 4. Compact OS (Fix for the ParserError)
        & compact.exe /compactos:always


    - name: 3. Credential Injection & ID Reveal
      shell: pwsh
      run: |
        # [span_5](start_span)Set access password[span_5](end_span)
        echo "GitHub@2026" | & "C:\AnyDesk\AnyDesk.exe" --set-password
        
        # [span_6](start_span)Dynamic ID extraction with retry logic[span_6](end_span)
        $idFile = "C:\ProgramData\AnyDesk\system.conf"
        $ID = ""
        $attempts = 0
        while (!$ID -and $attempts -lt 12) {
          if (Test-Path $idFile) { 
            $ID = Select-String -Path $idFile -Pattern "ad.anynet.id=(.*)" | % { $_.Matches.Groups[1].Value } 
          }
          Start-Sleep -Seconds 5
          $attempts++
        }
        
        Write-Host "====================================" -ForegroundColor Cyan
        Write-Host " PERFORMANCE RDP ACTIVE " -ForegroundColor Green
        Write-Host " ANYDESK ID: $ID" -ForegroundColor Yellow
        Write-Host " PASSWORD:    GitHub@2026" -ForegroundColor White
        Write-Host " TARGET:      1080p @ 60 FPS" -ForegroundColor Green
        Write-Host "====================================" -ForegroundColor Cyan

    - name: 4. The Infinite Ultra-Loop
      shell: pwsh
      run: |
        # [span_7](start_span)Keep alive for 6 hours[span_7](end_span)
        while ($true) { 
          Write-Host "Heartbeat: VM is running smoothly..."
          Start-Sleep -Seconds 3600 
        }

    - name: 5. Final Safety Sync
      if: always()
      shell: pwsh
      run: |
        # [span_8](start_span)Backup system registry for next session[span_8](end_span)
        reg export "HKEY_CURRENT_USER\Control Panel\Desktop" "C:\GamingVM\Backup\System.reg" /y
