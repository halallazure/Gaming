name: AnyDesk-VHD-Final-Fixed
on: workflow_dispatch

jobs:
  build:
    runs-on: windows-latest
    steps:
    - name: 0. Restore Virtual Disk
      continue-on-error: true
      shell: pwsh
      run: |
        choco install megacmd -y --no-progress
        $mega = "C:\Program Files\MEGAcmd\mega-exec.exe"
        if (Test-Path $mega) {
            & $mega login halallazure@gmail.com 123456seven.
            & $mega get /RDP_Backups/WorkData.vhd C:\WorkData.vhd
            & $mega logout
        }

    - name: 1. Mount Drive D: & Setup AnyDesk
      shell: pwsh
      run: |
        if (!(Test-Path "C:\WorkData.vhd")) {
            $vhdScript = @"
            create vdisk file="C:\WorkData.vhd" maximum=20000 type=expandable
            attach vdisk
            create partition primary
            format fs=ntfs quick label="WorkData"
            assign letter=D
        "@
            $vhdScript | diskpart
        } else {
            "attach vdisk file=`"C:\WorkData.vhd`"" | diskpart
        }
        
        curl.exe -L -o anydesk.exe https://download.anydesk.com/AnyDesk.exe
        ./anydesk.exe --install C:\AnyDesk --start-with-win --silent
        Start-Sleep -Seconds 5
        echo "GitHub@2026" | & "C:\AnyDesk\AnyDesk.exe" --set-password
        Start-Process "C:\AnyDesk\AnyDesk.exe" -ArgumentList "--service"

    - name: 2. ID Reveal & Persistence Shortcut
      shell: pwsh
      run: |
        $WshShell = New-Object -ComObject WScript.Shell
        $Shortcut = $WshShell.CreateShortcut("$HOME\Desktop\SAVE_HERE_D.lnk")
        $Shortcut.TargetPath = "D:\"
        $Shortcut.Save()

        if (Test-Path "D:\WindowsSettings.reg") { 
            reg import "D:\WindowsSettings.reg"
            RUNDLL32.EXE user32.dll,UpdatePerUserSystemParameters
        }

        $ID = Select-String -Path "C:\ProgramData\AnyDesk\system.conf" -Pattern "ad.anynet.id=(.*)" | ForEach-Object { $_.Matches.Groups[1].Value }
        Write-Host "------------------------------------------------"
        Write-Host "      ID: $ID | Password: GitHub@2026"
        Write-Host "------------------------------------------------"

    - name: 3. Session Timer
      shell: pwsh
      run: |
        $timeout = New-TimeSpan -Hours 5 -Minutes 30
        $stopwatch = [Diagnostics.Stopwatch]::StartNew()
        while ($stopwatch.Elapsed -lt $timeout) { Start-Sleep -Seconds 60 }

    - name: 4. THE BLOCKING SAVE
      if: always()
      shell: pwsh
      run: |
        $mega = "C:\Program Files\MEGAcmd\mega-exec.exe"
        if (Test-Path $mega) {
            reg export "HKCU\Control Panel\Desktop" "D:\WindowsSettings.reg" /y
            "detach vdisk file=`"C:\WorkData.vhd`"" | diskpart
            
            & $mega login halallazure@gmail.com 123456seven.
            & $mega rm /RDP_Backups/WorkData.vhd
            & $mega put "C:\WorkData.vhd" /RDP_Backups/
            
            do {
                $status = & $mega transfers
                Write-Host "Syncing to MEGA..."
                Start-Sleep -Seconds 10
            } while ($status -notlike "*No active transfers*")
            
            & $mega logout
        }
