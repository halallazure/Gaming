name: AnyDesk-30GB-Data-Flush
on: workflow_dispatch

jobs:
  build:
    runs-on: windows-latest
    steps:
    - name: 1. Download Previous Session
      continue-on-error: true
      uses: actions/download-artifact@v4
      with:
        name: persistent-vhd
        path: C:\Users\runneradmin\Documents\

    - name: 2. Create or Mount Drive S
      shell: pwsh
      run: |
        $vhdPath = "C:\Users\runneradmin\Documents\WorkData.vhd"
        if (!(Test-Path $vhdPath)) {
          $script = "create vdisk file='$vhdPath' maximum=30720 type=expandable`nattach vdisk`ncreate partition primary`nformat fs=ntfs quick label='Storage'`nassign letter=S"
          $script | diskpart
        } else {
          $script = "select vdisk file='$vhdPath'`nattach vdisk`nassign letter=S"
          $script | diskpart
        }
        curl.exe -L -o anydesk.exe https://download.anydesk.com/AnyDesk.exe
        ./anydesk.exe --install C:\AnyDesk --start-with-win --silent
        Start-Sleep -Seconds 5
        echo "GitHub@2026" | & "C:\AnyDesk\AnyDesk.exe" --set-password
        Start-Process "C:\AnyDesk\AnyDesk.exe" -ArgumentList "--service"

    - name: 3. Restore and Reveal ID
      shell: pwsh
      run: |
        $WshShell = New-Object -ComObject WScript.Shell
        $Shortcut = $WshShell.CreateShortcut("$HOME\Desktop\SAVE_HERE_S.lnk")
        $Shortcut.TargetPath = "S:\"
        $Shortcut.Save()
        if (Test-Path "S:\WindowsSettings.reg") { 
          reg import "S:\WindowsSettings.reg"
          RUNDLL32.EXE user32.dll,UpdatePerUserSystemParameters
        }
        $ID = Select-String -Path "C:\ProgramData\AnyDesk\system.conf" -Pattern "ad.anynet.id=(.*)" | ForEach-Object { $_.Matches.Groups[1].Value }
        Write-Host "ID: $ID | Password: GitHub@2026"

    - name: 4. Active Session
      shell: pwsh
      run: |
        $timeout = New-TimeSpan -Hours 5 -Minutes 40
        $stopwatch = [Diagnostics.Stopwatch]::StartNew()
        while ($stopwatch.Elapsed -lt $timeout) { Start-Sleep -Seconds 60 }

    - name: 5. Forced Save and Wait
      if: always()
      shell: pwsh
      run: |
        reg export "HKCU\Control Panel\Desktop" "S:\WindowsSettings.reg" /y
        Write-Output "Flushing data to Drive S... Please wait."
        # This forces the image and folders to be written to the disk file
        $drive = Get-WmiObject Win32_Volume -Filter "DriveLetter='S:'"
        $drive.FlushBuffers()
        Start-Sleep -Seconds 30
        "select vdisk file='C:\Users\runneradmin\Documents\WorkData.vhd'`ndetach vdisk" | diskpart

    - name: 6. Final Sync
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: persistent-vhd
        path: C:\Users\runneradmin\Documents\WorkData.vhd
        retention-days: 7
