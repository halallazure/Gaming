name: Parsec-Gaming-VM
on: workflow_dispatch
jobs:
  build:
    runs-on: windows-latest
    steps:
    - name: Setup Tailscale
      run: |
        Invoke-WebRequest https://pkgs.tailscale.com/stable/tailscale-setup-latest.exe -OutFile tailscale-setup.exe
        Start-Process -FilePath .\tailscale-setup.exe -ArgumentList "/quiet" -Wait
    - name: Connect to Tailscale
      shell: pwsh
      run: |
        & 'C:\Program Files\Tailscale\tailscale.exe' up --authkey=${{ secrets.TAILSCALE_AUTHKEY }} --accept-routes
    - name: Install Virtual Display & Parsec
      shell: pwsh
      run: |
        # 1. Install Parsec
        Invoke-WebRequest "https://builds.parsec.app/package/parsec-windows.exe" -Outfile "parsec.exe"
        Start-Process .\parsec.exe -ArgumentList "/silent" -Wait
        
        # 2. Install Virtual Display Driver (Crucial for Headless)
        Invoke-WebRequest "https://github.com/VirtualDrivers/Virtual-Display-Driver/releases/latest/download/VirtualDisplayDriver.exe" -Outfile "vdd.exe"
        Start-Process .\vdd.exe -ArgumentList "/S" -Wait
        
        # 3. Configure Windows for Remote Access
        net user runneradmin GamingVM123!
        Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0
        Enable-NetFirewallRule -DisplayGroup "Remote Desktop"
    - name: Keep Alive
      run: |
        Write-Host "VM Ready. Login to Parsec inside the VM via RDP first!"
        Start-Sleep -Seconds 21600
