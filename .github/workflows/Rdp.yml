name: Connect-RDP
on: workflow_dispatch
jobs:
  build:
    runs-on: windows-latest
    steps:
    - name: 1. Download AnyDesk
      run: curl.exe -L -o anydesk.exe https://download.anydesk.com/AnyDesk.exe

    - name: 2. Set Password & Start Service
      run: |
        # Set password using the pipe method
        echo "MySafePassword123!" | ./anydesk.exe --set-password
        # Start as a service to trigger ID generation
        ./anydesk.exe --service &
        Start-Sleep -Seconds 45
      shell: pwsh

    - name: 3. REVEAL ID (Multi-Method)
      run: |
        # Method A: Try Command Line
        $ID_A = ./anydesk.exe --get-id
        
        # Method B: Search the Registry (Modern 2026 Path)
        $ID_B = (Get-ItemProperty -Path "HKLM:\SOFTWARE\WOW6432Node\AnyDesk").ad_anynet_id
        
        # Method C: Read the Config File
        $conf = "$env:ProgramData\AnyDesk\system.conf"
        if (Test-Path $conf) {
          $ID_C = Select-String -Path $conf -Pattern "ad.anynet.id=(.*)" | ForEach-Object { $_.Matches.Groups[1].Value }
        }

        Write-Host "------------------------------------------------" -ForegroundColor Green
        Write-Host "METHOD A (CMD): $ID_A" -ForegroundColor Cyan
        Write-Host "METHOD B (REG): $ID_B" -ForegroundColor Cyan
        Write-Host "METHOD C (FILE): $ID_C" -ForegroundColor Cyan
        Write-Host "PASSWORD: MySafePassword123!" -ForegroundColor Yellow
        Write-Host "------------------------------------------------" -ForegroundColor Green
      shell: pwsh

    - name: 4. Keep Alive
      run: while($true){ Start-Sleep -Seconds 60 }
      shell: pwsh
