name: AnyDesk-Back-To-Working
on: workflow_dispatch
jobs:
  build:
    runs-on: windows-latest
    steps:
    - name: 1. Nuke & Start AnyDesk
      run: |
        # Deleting these folders forces a fresh ID generation
        Stop-Process -Name AnyDesk -ErrorAction SilentlyContinue
        if (Test-Path "C:\ProgramData\AnyDesk") { Remove-Item -Path "C:\ProgramData\AnyDesk" -Recurse -Force }
        if (Test-Path "$env:AppData\AnyDesk") { Remove-Item -Path "$env:AppData\AnyDesk" -Recurse -Force }
        
        # Download AnyDesk
        curl.exe -L -o anydesk.exe https://download.anydesk.com/AnyDesk.exe
        
        # Set Password and Start Service
        echo "MySafePassword123!" | ./anydesk.exe --set-password
        ./anydesk.exe --service &
      shell: pwsh

    - name: 2. WAIT AND FIND ID (Will not stop until found)
      run: |
        Write-Host "Searching for AnyDesk ID... Please wait..." -ForegroundColor Yellow
        $count = 0
        while ($count -lt 20) {
            # Try Method A: Command Line
            $ID = ./anydesk.exe --get-id
            
            # Try Method B: System Config File
            $conf = "C:\ProgramData\AnyDesk\system.conf"
            if (Test-Path $conf) {
               $fileID = Select-String -Path $conf -Pattern "ad.anynet.id=(.*)" | ForEach-Object { $_.Matches.Groups[1].Value }
            }
            
            if ($ID -or $fileID) {
                Write-Host "------------------------------------------------" -ForegroundColor Green
                Write-Host "SUCCESS! ID FOUND." -ForegroundColor Green
                if ($ID) { Write-Host "ANYDESK ID: $ID" -ForegroundColor Cyan }
                if ($fileID) { Write-Host "ANYDESK ID (Backup): $fileID" -ForegroundColor Cyan }
                Write-Host "PASSWORD: MySafePassword123!" -ForegroundColor Yellow
                Write-Host "------------------------------------------------" -ForegroundColor Green
                break
            }
            
            Write-Host "ID not ready yet, retrying in 10 seconds... ($count/20)"
            Start-Sleep -Seconds 10
            $count++
        }
      shell: pwsh

    - name: 3. Keep Alive
      run: while($true){ Start-Sleep -Seconds 60 }
