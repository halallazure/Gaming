name: Cloudflare-Direct-RDP
on: workflow_dispatch
jobs:
  build:
    runs-on: windows-latest
    steps:
    - name: 1. Enable Remote Desktop
      run: |
        Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -name "fDenyTSConnections" -Value 0
        Enable-NetFirewallRule -DisplayGroup "Remote Desktop"
        Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -name "UserAuthentication" -Value 1
        net user runneradmin MySafePassword123!
      shell: pwsh

    - name: 2. Setup Cloudflare Tunnel
      run: |
        curl.exe -L -o cloudflared.exe https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-windows-amd64.exe
      shell: pwsh

    - name: 3. Start Tunnel and Reveal URL
      run: |
        # Start tunnel in background to bridge RDP port 3389
        Start-Process ./cloudflared.exe -ArgumentList "tunnel --url tcp://localhost:3389"
        Start-Sleep -Seconds 20
        
        # Pull the link from the logs
        Write-Host "------------------------------------------------" -ForegroundColor Green
        Write-Host "YOUR CONNECTION DETAILS ARE BELOW" -ForegroundColor Yellow
        Write-Host "USER: runneradmin" -ForegroundColor White
        Write-Host "PASS: MySafePassword123!" -ForegroundColor White
        Write-Host "------------------------------------------------" -ForegroundColor Green
        Write-Host "Looking for Cloudflare link..." -ForegroundColor Cyan
        
        # This will print the tunnel logs so you can copy the 'trycloudflare.com' link
        Get-Content -Path "$env:TEMP\cloudflared.log" -ErrorAction SilentlyContinue
      shell: pwsh

    - name: 4. Keep Alive
      run: while($true){ Start-Sleep -Seconds 60 }
