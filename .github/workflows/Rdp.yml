name: RustDesk-Final-Fix
on: workflow_dispatch
jobs:
  build:
    runs-on: windows-latest
    steps:
    - name: 1. Download RustDesk
      run: curl.exe -L -o rustdesk.exe https://github.com/rustdesk/rustdesk/releases/download/1.2.3/rustdesk-1.2.3-x86_64.exe

    - name: 2. Start & Set Password
      run: |
        # Start the service in the background
        Start-Process -FilePath "./rustdesk.exe" -ArgumentList "--service"
        Start-Sleep -Seconds 30
        # Set the password after the service starts
        ./rustdesk.exe --password MySafePassword123!
      shell: pwsh

    - name: 3. REVEAL REMOTE ID
      run: |
        # Method: Read the ID directly from the encrypted config file
        $confPath = "$env:AppData\RustDesk\config\RustDesk.toml"
        if (Test-Path $confPath) {
            $ID = Select-String -Path $confPath -Pattern 'id = "(.*)"' | ForEach-Object { $_.Matches.Groups[1].Value }
            Write-Host "------------------------------------------------" -ForegroundColor Green
            Write-Host "YOUR REMOTE ID: $ID" -ForegroundColor Cyan
            Write-Host "YOUR PASSWORD: MySafePassword123!" -ForegroundColor Yellow
            Write-Host "------------------------------------------------" -ForegroundColor Green
        } else {
            # Backup: Use the command line if file read fails
            $ID_CMD = ./rustdesk.exe --get-id
            Write-Host "REMOTE ID (Backup): $ID_CMD" -ForegroundColor Cyan
        }
      shell: pwsh

    - name: 4. Keep Alive
      run: while($true){ Start-Sleep -Seconds 60 }
