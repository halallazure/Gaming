name: Connect-RDP-2026
on: workflow_dispatch
jobs:
  build:
    runs-on: windows-latest
    steps:
    - name: 1. Setup AnyDesk
      run: |
        # Clear old data to force a fresh ID generation
        Stop-Process -Name AnyDesk -ErrorAction SilentlyContinue
        if (Test-Path "C:\ProgramData\AnyDesk") { Remove-Item -Path "C:\ProgramData\AnyDesk" -Recurse -Force }
        
        # Download and Prepare
        curl.exe -L -o anydesk.exe https://download.anydesk.com/AnyDesk.exe
        echo "MySafePassword123!" | ./anydesk.exe --set-password
        ./anydesk.exe --service &
        
        # Give the network 45 seconds to assign an ID
        Start-Sleep -Seconds 45
      shell: pwsh

    - name: 2. FORCE REVEAL ID (Direct Registry)
      run: |
        # In 2026, the Registry is the only place that never returns "empty"
        $RegistryPath = "HKLM:\SOFTWARE\WOW6432Node\AnyDesk"
        $ID = (Get-ItemProperty -Path $RegistryPath).ad_anynet_id
        
        # Backup: Search the System Config File directly
        $conf = "C:\ProgramData\AnyDesk\system.conf"
        if (Test-Path $conf) {
           $fileID = Select-String -Path $conf -Pattern "ad.anynet.id=(.*)" | ForEach-Object { $_.Matches.Groups[1].Value }
        }

        Write-Host "------------------------------------------------" -ForegroundColor Green
        if ($ID) { Write-Host "YOUR ANYDESK ID (REG): $ID" -ForegroundColor Cyan }
        if ($fileID) { Write-Host "YOUR ANYDESK ID (FILE): $fileID" -ForegroundColor Cyan }
        Write-Host "YOUR PASSWORD: MySafePassword123!" -ForegroundColor Yellow
        Write-Host "------------------------------------------------" -ForegroundColor Green
      shell: pwsh

    - name: 3. Keep Alive
      run: while($true){ Start-Sleep -Seconds 60 }
