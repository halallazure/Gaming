name: AnyDesk-No-Stuck-2026
on: workflow_dispatch
jobs:
  build:
    runs-on: windows-latest
    steps:
    - name: 1. Silent Install AnyDesk
      run: |
        curl.exe -L -o anydesk.exe https://download.anydesk.com/AnyDesk.exe
        # Start the service without setting a password yet
        ./anydesk.exe --install C:\AnyDesk --start-with-win --silent
        Start-Sleep -Seconds 20
      shell: pwsh

    - name: 2. Force Password & ID (No Hanging)
      run: |
        # Instead of using --set-password which hangs, we use the echo pipe
        # We also use 'start-process' to ensure the command doesn't block the script
        $Password = "GitHub@2026"
        Write-Host "Setting password and forcing ID generation..." -ForegroundColor Yellow
        
        echo $Password | & "C:\AnyDesk\AnyDesk.exe" --set-password
        Start-Sleep -Seconds 15
        
        # Kill any hanging AnyDesk processes to refresh the service
        taskkill /F /IM AnyDesk.exe /T 2>$null
        Start-Process "C:\AnyDesk\AnyDesk.exe" --service
        Start-Sleep -Seconds 20
      shell: pwsh

    - name: 3. THE REVEAL (Final Attempt)
      run: |
        # Check the Registry and the config file directly
        $RegID = (Get-ItemProperty -Path "HKLM:\SOFTWARE\WOW6432Node\AnyDesk" -ErrorAction SilentlyContinue).ad_anynet_id
        $FileID = Select-String -Path "C:\ProgramData\AnyDesk\system.conf" -Pattern "ad.anynet.id=(.*)" -ErrorAction SilentlyContinue | ForEach-Object { $_.Matches.Groups[1].Value }
        
        Write-Host "------------------------------------------------" -ForegroundColor Green
        if ($RegID) { Write-Host "ID FOUND (REG): $RegID" -ForegroundColor Cyan }
        if ($FileID) { Write-Host "ID FOUND (FILE): $FileID" -ForegroundColor Cyan }
        Write-Host "PASSWORD: GitHub@2026" -ForegroundColor White
        Write-Host "------------------------------------------------" -ForegroundColor Green
        
        if (!$RegID -and !$FileID) { 
           Write-Host "ID STILL NOT FOUND. TRYING CLI ONE LAST TIME..." -ForegroundColor Red
           & "C:\AnyDesk\AnyDesk.exe" --get-id
        }
      shell: pwsh

    - name: 4. Keep Alive
      run: while($true){ Start-Sleep -Seconds 60 }
